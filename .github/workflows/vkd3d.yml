name: VKD3D-Proton

on:
  schedule:
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      FORCE_MODE:
        type: boolean
        default: false
      VERSION:
        description: "Version (e.g., 3.0b, leave empty for latest)"
        required: false
        default: ""
      SHADER_MODEL:
        type: choice
        default: "6_6"
        options:
          - "6_5"
          - "6_6"
          - "6_7"
          - "6_8"
      FEATURE_LEVEL:
        type: choice
        default: "12_2"
        options:
          - "12_0"
          - "12_1"
          - "12_2"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

defaults:
  run:
    shell: 'bash --noprofile --norc -Eeuo pipefail {0}'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Build Environment
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            git meson ninja-build curl jq python3 \
            glslang-tools spirv-tools zstd \
            gcc-mingw-w64-x86-64 gcc-mingw-w64-i686 \
            g++-mingw-w64-x86-64 g++-mingw-w64-i686 \
            mingw-w64 mingw-w64-tools
          
          sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix 2>/dev/null || true
          sudo update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix 2>/dev/null || true

      - name: Fetch Version
        run: |
          if [[ -n "${{ inputs.VERSION }}" ]]; then
            INPUT_VER="${{ inputs.VERSION }}"
            [[ "$INPUT_VER" =~ ^v ]] && LATEST_TAG="$INPUT_VER" || LATEST_TAG="v$INPUT_VER"
          else
            LATEST_TAG=$(curl -sL --retry 3 \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | \
              jq -r '.tag_name // empty')
            
            if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
              LATEST_TAG=$(curl -sL --retry 3 \
                https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases | \
                jq -r '.[0].tag_name // empty')
            fi
          fi
          
          [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]] && { echo "ERROR: No version found"; exit 1; }
          
          VER="${LATEST_TAG#v}"
          SHADER_MODEL="${{ inputs.SHADER_MODEL || '6_6' }}"
          FEATURE_LEVEL="${{ inputs.FEATURE_LEVEL || '12_2' }}"
          
          echo "TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "VER=$VER" >> $GITHUB_ENV
          echo "SHADER_MODEL=$SHADER_MODEL" >> $GITHUB_ENV
          echo "FEATURE_LEVEL=$FEATURE_LEVEL" >> $GITHUB_ENV
          
          echo "Version: $LATEST_TAG ($VER), SM: $SHADER_MODEL, FL: $FEATURE_LEVEL"

      - name: Check Release
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="vkd3d-${{ env.VER }}-sm${{ env.SHADER_MODEL }}-fl${{ env.FEATURE_LEVEL }}"
          EXISTS=$(gh release view "$RELEASE_TAG" --repo ${{ github.repository }} > /dev/null 2>&1 && echo "true" || echo "false")
          [[ "${{ inputs.FORCE_MODE }}" == "true" ]] && EXISTS="false"
          echo "SKIP=$EXISTS" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Clone Source
        if: steps.check.outputs.SKIP == 'false'
        run: |
          git clone --recursive --branch ${{ env.TAG }} https://github.com/HansKristian-Work/vkd3d-proton.git src
          cd src
          [[ ! -f "./package-release.sh" ]] && { echo "ERROR: package-release.sh not found"; exit 1; }
          chmod +x ./package-release.sh
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          echo "COMMIT=$COMMIT_SHORT" >> $GITHUB_ENV

      - name: Apply Patches
        if: steps.check.outputs.SKIP == 'false'
        env:
          SHADER_MODEL: ${{ env.SHADER_MODEL }}
          FEATURE_LEVEL: ${{ env.FEATURE_LEVEL }}
        run: |
          cd src
          cat > dragon_patch.py << 'EOF'
          import re, os, sys

          class Patcher:
              def __init__(self):
                  self.sm = os.environ.get("SHADER_MODEL", "6_6")
                  self.fl = os.environ.get("FEATURE_LEVEL", "12_2")
                  self.applied = 0

              def patch(self, content, patterns):
                  for p, r in patterns:
                      if re.search(p, content):
                          content = re.sub(p, r, content, count=1)
                          self.applied += 1
                          return content, True
                  return content, False

              def run(self):
                  print(f"Dragon Patcher - SM {self.sm}, FL {self.fl}")
                  
                  if not os.path.exists("libs/vkd3d/device.c"):
                      print("ERROR: device.c not found")
                      return 1

                  with open("libs/vkd3d/device.c", "r") as f:
                      c = f.read()

                  fl_map = {"12_0": "D3D_FEATURE_LEVEL_12_0", "12_1": "D3D_FEATURE_LEVEL_12_1", "12_2": "D3D_FEATURE_LEVEL_12_2"}
                  fl_val = fl_map.get(self.fl, "D3D_FEATURE_LEVEL_12_2")

                  patches = [
                      [(r'(data->HighestShaderModel\s*=\s*)[^;]+;', f'\\1D3D_SHADER_MODEL_{self.sm};')],
                      [(r'(MaxSupportedFeatureLevel\s*=\s*)[^;]+;', f'\\1{fl_val};'),
                       (r'(max_feature_level\s*=\s*)[^;]+;', f'\\1{fl_val};')],
                      [(r'(options1\.WaveOps\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->WaveOps\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options1\.WaveLaneCountMin\s*=\s*)[^;]+;', '\\g<1>32;'),
                       (r'(data->WaveLaneCountMin\s*=\s*)[^;]+;', '\\g<1>32;')],
                      [(r'(options1\.WaveLaneCountMax\s*=\s*)[^;]+;', '\\g<1>64;'),
                       (r'(data->WaveLaneCountMax\s*=\s*)[^;]+;', '\\g<1>64;')],
                      [(r'(options7\.MeshShaderTier\s*=\s*)[^;]+;', '\\1D3D12_MESH_SHADER_TIER_1;'),
                       (r'(data->MeshShaderTier\s*=\s*)[^;]+;', '\\1D3D12_MESH_SHADER_TIER_1;')],
                      [(r'(options7\.SamplerFeedbackTier\s*=\s*)[^;]+;', '\\1D3D12_SAMPLER_FEEDBACK_TIER_0_9;'),
                       (r'(data->SamplerFeedbackTier\s*=\s*)[^;]+;', '\\1D3D12_SAMPLER_FEEDBACK_TIER_0_9;')],
                      [(r'(options\.ResourceBindingTier\s*=\s*)[^;]+;', '\\1D3D12_RESOURCE_BINDING_TIER_3;'),
                       (r'(data->ResourceBindingTier\s*=\s*)[^;]+;', '\\1D3D12_RESOURCE_BINDING_TIER_3;')],
                      [(r'(options\.TiledResourcesTier\s*=\s*)[^;]+;', '\\1D3D12_TILED_RESOURCES_TIER_3;'),
                       (r'(data->TiledResourcesTier\s*=\s*)[^;]+;', '\\1D3D12_TILED_RESOURCES_TIER_3;')],
                      [(r'(options\.ConservativeRasterizationTier\s*=\s*)[^;]+;', '\\1D3D12_CONSERVATIVE_RASTERIZATION_TIER_3;'),
                       (r'(data->ConservativeRasterizationTier\s*=\s*)[^;]+;', '\\1D3D12_CONSERVATIVE_RASTERIZATION_TIER_3;')],
                      [(r'(options\.ResourceHeapTier\s*=\s*)[^;]+;', '\\1D3D12_RESOURCE_HEAP_TIER_2;'),
                       (r'(data->ResourceHeapTier\s*=\s*)[^;]+;', '\\1D3D12_RESOURCE_HEAP_TIER_2;')],
                      [(r'(options5\.RaytracingTier\s*=\s*)[^;]+;', '\\1D3D12_RAYTRACING_TIER_1_0;'),
                       (r'(data->RaytracingTier\s*=\s*)[^;]+;', '\\1D3D12_RAYTRACING_TIER_1_0;')],
                      [(r'(options6\.VariableShadingRateTier\s*=\s*)[^;]+;', '\\1D3D12_VARIABLE_SHADING_RATE_TIER_2;'),
                       (r'(data->VariableShadingRateTier\s*=\s*)[^;]+;', '\\1D3D12_VARIABLE_SHADING_RATE_TIER_2;')],
                      [(r'(options12\.EnhancedBarriersSupported\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->EnhancedBarriersSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options\.DoublePrecisionFloatShaderOps\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->DoublePrecisionFloatShaderOps\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options\.OutputMergerLogicOp\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->OutputMergerLogicOp\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options1\.Int64ShaderOps\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->Int64ShaderOps\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options\.ROVsSupported\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->ROVsSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options\.VPAndRTArrayIndexFromAnyShaderFeedingRasterizerSupportedWithoutGSEmulation\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options2\.DepthBoundsTestSupported\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->DepthBoundsTestSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options2\.ProgrammableSamplePositionsTier\s*=\s*)[^;]+;', '\\1D3D12_PROGRAMMABLE_SAMPLE_POSITIONS_TIER_2;')],
                      [(r'(options3\.CastingFullyTypedFormatSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options3\.WriteBufferImmediateSupportFlags\s*=\s*)[^;]+;', '\\1D3D12_COMMAND_LIST_SUPPORT_FLAG_DIRECT | D3D12_COMMAND_LIST_SUPPORT_FLAG_COMPUTE;')],
                      [(r'(options4\.Native16BitShaderOpsSupported\s*=\s*)[^;]+;', '\\1TRUE;'),
                       (r'(data->Native16BitShaderOpsSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options4\.MSAA64KBAlignedTextureSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options6\.AdditionalShadingRatesSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options6\.ShadingRateImageTileSize\s*=\s*)[^;]+;', '\\g<1>16;')],
                      [(r'(options8\.UnalignedBlockTexturesSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options9\.AtomicInt64OnTypedResourceSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options9\.AtomicInt64OnGroupSharedSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options9\.DerivativesInMeshAndAmplificationShadersSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options9\.MeshShaderPipelineStatsSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options9\.MeshShaderSupportsFullRangeRenderTargetArrayIndex\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options10\.MeshShaderPerPrimitiveShadingRateSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options11\.AtomicInt64OnDescriptorHeapResourceSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options12\.RelaxedFormatCastingSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options13\.UnrestrictedBufferTextureCopyPitchSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options13\.UnrestrictedVertexElementAlignmentSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options13\.InvertedViewportHeightFlipsYSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options13\.InvertedViewportDepthFlipsZSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options13\.AlphaBlendFactorSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options14\.AdvancedTextureOpsSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options14\.WriteableMSAATexturesSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options14\.IndependentFrontAndBackStencilRefMaskSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options15\.TriangleFanSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options15\.DynamicIndexBufferStripCutSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options16\.DynamicDepthBiasSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options17\.NonNormalizedCoordinateSamplersSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options18\.RenderPassesValid\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options19\.MaxSamplerDescriptorHeapSize\s*=\s*)[^;]+;', '\\g<1>4096;')],
                      [(r'(options19\.MaxSamplerDescriptorHeapSizeWithStaticSamplers\s*=\s*)[^;]+;', '\\g<1>4096;')],
                      [(r'(options19\.MaxViewDescriptorHeapSize\s*=\s*)[^;]+;', '\\g<1>1000000;')],
                      [(r'(options20\.RecreateAtTier\s*=\s*)[^;]+;', '\\1D3D12_RECREATE_AT_TIER_1;')],
                      [(r'(options21\.ExecuteIndirectTier\s*=\s*)[^;]+;', '\\1D3D12_EXECUTE_INDIRECT_TIER_1_1;')],
                      [(r'(options21\.SampleCmpGradientAndBiasSupported\s*=\s*)[^;]+;', '\\1TRUE;')],
                      [(r'(options21\.WorkGraphsTier\s*=\s*)[^;]+;', '\\1D3D12_WORK_GRAPHS_TIER_1_0;')],
                  ]

                  for p_list in patches:
                      c, _ = self.patch(c, p_list)

                  with open("libs/vkd3d/device.c", "w") as f:
                      f.write(c)

                  print(f"Patches applied: {self.applied}")
                  return 0 if self.applied >= 1 else 1

          if __name__ == "__main__":
              sys.exit(Patcher().run())
          EOF
          
          python3 dragon_patch.py

      - name: Build
        if: steps.check.outputs.SKIP == 'false'
        run: |
          cd src
          export CFLAGS="-O3 -DNDEBUG"
          export CXXFLAGS="-O3 -DNDEBUG"
          bash ./package-release.sh ${{ env.TAG }} ../out --no-package

      - name: Verify Build
        if: steps.check.outputs.SKIP == 'false'
        run: |
          SRC_PATH=$(find out -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
          [[ -z "$SRC_PATH" ]] && { echo "ERROR: Build not found"; exit 1; }
          
          for arch in x64 x86; do
            for dll in d3d12.dll d3d12core.dll; do
              [[ ! -f "$SRC_PATH/$arch/$dll" ]] && { echo "ERROR: Missing $arch/$dll"; exit 1; }
            done
          done
          
          echo "SRC_PATH=$SRC_PATH" >> $GITHUB_ENV
          echo "Build OK"

      - name: Package
        if: steps.check.outputs.SKIP == 'false'
        run: |
          mkdir -p staging/system32 staging/syswow64
          cp "${{ env.SRC_PATH }}/x64/"*.dll staging/system32/
          cp "${{ env.SRC_PATH }}/x86/"*.dll staging/syswow64/
          
          cat > staging/profile.json << EOF
          {
            "type": "VKD3D",
            "versionName": "${{ env.VER }}-Dragon",
            "versionCode": $(date +%Y%m%d),
            "description": "VKD3D-Proton ${{ env.VER }} Dragon - SM${{ env.SHADER_MODEL }} FL${{ env.FEATURE_LEVEL }}",
            "files": [
              {"source": "system32/d3d12.dll", "target": "\${system32}/d3d12.dll"},
              {"source": "system32/d3d12core.dll", "target": "\${system32}/d3d12core.dll"},
              {"source": "syswow64/d3d12.dll", "target": "\${syswow64}/d3d12.dll"},
              {"source": "syswow64/d3d12core.dll", "target": "\${syswow64}/d3d12core.dll"}
            ]
          }
          EOF
          
          PACKAGE_NAME="vkd3d-proton-${{ env.VER }}-SM${{ env.SHADER_MODEL }}-FL${{ env.FEATURE_LEVEL }}-Dragon-${{ env.COMMIT }}"
          cd staging && tar --zstd -cf "../${PACKAGE_NAME}.wcp" . && cd ..
          
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Upload Artifact
        if: steps.check.outputs.SKIP == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: ${{ env.PACKAGE_NAME }}.wcp
          retention-days: 90

      - name: Release
        if: steps.check.outputs.SKIP == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}-${{ env.COMMIT }}
          name: "VKD3D-Proton ${{ env.VER }} (${{ env.COMMIT }})"
          files: ${{ env.PACKAGE_NAME }}.wcp
          body: |
            **VKD3D-Proton ${{ env.VER }}** - Dragon Build
            
            - Shader Model: ${{ env.SHADER_MODEL }}
            - Feature Level: ${{ env.FEATURE_LEVEL }}
            - Commit: ${{ env.COMMIT }}
